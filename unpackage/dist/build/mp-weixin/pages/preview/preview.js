"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/system.js"),l=require("../../api/apis.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-rate")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../uni_modules/uni-rate/components/uni-rate/uni-rate.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const o={__name:"preview",setup(o){const t=e.ref(!0),i=e.ref(null),n=e.ref(null),s=e.ref(0),u=e.index.getStorageSync("storgClassList")||[],r=e.ref([]),c=e.ref(null),d=e.ref(0),p=e.ref([]),v=e.ref(null),m=e.ref(!1);r.value=u.map((e=>({...e,picurl:e.smallPicurl.replace("_small.webp",".jpg")}))),console.log(r.value);const f=()=>{e.index.navigateBack({success:()=>{},fail:a=>{e.index.reLaunch({url:"/pages/index/index"})}})},h=()=>{t.value=!t.value},g=function(){i.value.open()},w=()=>{i.value.close()},x=()=>{v.value.userScore&&(m.value=!0,s.value=v.value.userScore),n.value.open()},y=()=>{n.value.close(),s.value=0,m.value=!1},_=async()=>{e.index.showLoading({title:"加载中......"});let{classid:a,_id:o}=v.value;console.log(v.value);let t=await l.apiGetSetupScore({classid:a,wallId:o,userScore:s.value});e.index.hideLoading(),0===t.errCode&&(e.index.showToast({title:"评分成功!",icon:"none"}),r.value[d.value].userScore=s.value,e.index.setStorageSync("storgClassList",r.value),y()),console.log(t)};e.onLoad((async a=>{if(c.value=a.id,"share"==a.type){let e=await l.apiDetailWall({id:c.value});r.value=e.data.map((e=>({...e,picurl:e.smallPicurl.replace("_small.webp",".jpg")})))}if(d.value=r.value.findIndex((e=>e._id==c.value)),-1===d.value)return e.index.showToast({title:"壁纸不存在",icon:"none"}),void setTimeout((()=>e.index.navigateBack()),1500);v.value=r.value[d.value],S()}));const b=e=>{d.value=e.detail.current,v.value=r.value[d.value],S()};function S(){p.value.push(d.value-1<=0?r.value.length-1:d.value-1,d.value,d.value+1>=r.value.length-1?0:d.value+1),p.value=[...new Set(p.value)]}const k=async()=>{try{e.index.showLoading({title:"下载中...",mask:!0});let{classid:a,_id:o}=v.value,t=await l.apiWriteDownload({classid:a,wallId:o});if(0!=t.errCode)throw t;e.index.getImageInfo({src:v.value.picurl,success:a=>{e.index.saveImageToPhotosAlbum({filePath:a.path,success:a=>{e.index.showToast({title:"保存成功，请到相册查看",icon:"none"})},fail:a=>{"saveImageToPhotosAlbum:fail cancel"!=a.errMsg?e.index.showModal({title:"授权提示",content:"需要授权保存相册",success:a=>{a.confirm&&e.index.openSetting({success:a=>{console.log(a),a.authSetting["scope.writePhotosAlbum"]?e.index.showToast({title:"获取授权成功",icon:"none"}):e.index.showToast({title:"获取权限失败",icon:"none"})}})}}):e.index.showToast({title:"保存失败，请重新点击下载",icon:"none"})},complete:()=>{e.index.hideLoading()}})}})}catch(a){console.log(a),e.index.hideLoading()}};return e.onShareAppMessage((e=>({title:"MyWallPaper",path:"/pages/preview/preview?id="+c.value+"&type=share"}))),e.onShareTimeline((e=>({title:"MyWallPaper",query:"id="+c.value+"&type=share"}))),(l,o)=>e.e({a:v.value},v.value?{b:e.f(r.value,((a,l,o)=>e.e({a:p.value.includes(l)},p.value.includes(l)?{b:e.o(h,a._id),c:a.picurl}:{},{d:a._id}))),c:d.value,d:e.o(b),e:e.p({type:"back",color:"#fff",size:"20"}),f:e.unref(a.getStatusBarHeight)()+"px",g:e.o(f),h:e.t(d.value+1),i:e.t(r.value.length),j:e.p({date:new Date,format:"hh:mm"}),k:e.p({date:new Date,format:"MM月dd日"}),l:e.p({type:"info",size:"28"}),m:e.o(g),n:e.p({type:"star",size:"28"}),o:e.t(v.value.score),p:e.o(x),q:e.p({type:"download",size:"28"}),r:e.o(k),s:t.value,t:e.p({type:"closeempty",size:"18",color:"#999"}),v:e.o(w),w:e.t(v.value._id),x:e.t(v.value.nickname),y:e.p({touchable:"false",readonly:"true",value:v.value.score,size:"16"}),z:e.t(v.value.score),A:e.t(v.value.description),B:e.f(v.value.tabs,((a,l,o)=>({a:e.t(a),b:a}))),C:e.sr(i,"db959d81-6",{k:"infoPopup"}),D:e.p({type:"bottom","is-mask-click":!1}),E:e.t(m.value?"已经评分过了~":"壁纸评分"),F:e.p({type:"closeempty",size:"18",color:"#999"}),G:e.o(y),H:e.o((e=>s.value=e)),I:e.p({allowHalf:!0,disabled:m.value,"disabled-color":"#FFCA3E",modelValue:s.value}),J:e.t(s.value),K:e.o(_),L:!s.value||m.value,M:e.sr(n,"db959d81-9",{k:"scorePopup"}),N:e.p({"is-mask-click":!1,"safe-area":!1})}:{})}},t=e._export_sfc(o,[["__scopeId","data-v-db959d81"]]);o.__runtimeHooks=6,wx.createPage(t);
